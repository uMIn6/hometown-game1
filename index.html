<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¸Œæœ›æ—…ç¨‹</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --panel:#111827ee;   /* gray-900/93 */
      --card:#0b1222;      /* dark card */
      --muted:#9ca3af;     /* gray-400 */
      --acc:#22c55e;       /* green-500 */
      --acc-2:#38bdf8;     /* sky-400 */
      --warn:#f59e0b;      /* amber-500 */
      --danger:#ef4444;    /* red-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -10%, #1e293b 0%, #0b1020 45%, var(--bg) 100%);
      color:#e5e7eb; overflow:hidden;
    }
    .app{display:grid; grid-template-columns: 320px 1fr 360px; gap:16px; height:100%; padding:16px}
    @media (max-width: 1100px){.app{grid-template-columns:1fr; grid-template-rows:auto auto 1fr; overflow:auto}}
    .panel{background:linear-gradient(180deg, #0c1428 0%, #0a0f1d 100%); border:1px solid #1f2a44; border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 6px; font-size:22px; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px}
    .row{display:flex; gap:8px; align-items:center}
    .stack{display:flex; flex-direction:column; gap:8px}
    .kpi{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
    .kpi .card{background:var(--card); border:1px solid #1e293b; border-radius:12px; padding:10px}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .val{font-weight:700; font-size:20px}
    .money{font-size:28px; font-weight:800}
    .pill{padding:4px 8px; background:#0f172a; border:1px solid #1f2a44; border-radius:999px; font-size:12px; color:var(--muted)}
    .btn{cursor:pointer; background:linear-gradient(180deg, #12325a 0%, #0d2545 100%); border:1px solid #1e3a5f; border-radius:12px; padding:10px 12px; color:#e5e7eb; font-weight:600}
    .btn:hover{filter:brightness(1.1)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn-acc{background:linear-gradient(180deg, #1f9e54 0%, #157d3f 100%); border-color:#1a7a45}
    .btn-warn{background:linear-gradient(180deg, #b97709 0%, #946107 100%); border-color:#9a6b09}
    .btn-ghost{background:#0a1222; border-color:#1f2a44}

    .progress{height:8px; background:#0b1222; border-radius:999px; overflow:hidden; border:1px solid #1f2a44}
    .bar{height:100%; background:linear-gradient(90deg, var(--acc), var(--acc-2)); width:0%}

    .cards{display:flex; flex-direction:column; gap:12px; overflow:auto; height:calc(100% - 40px); padding-right:4px}
    .card{background:linear-gradient(180deg, #0f1a32 0%, #0b1222 100%); border:1px solid #1f2a44; border-radius:16px; padding:14px}
    .card h3{margin:0 0 6px}
    .muted{color:var(--muted)}
    .right .project{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
    .tag{font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #1f2a44; color:#cbd5e1; background:#0b1222}
    .statrow{display:grid; grid-template-columns:1fr 1fr; gap:6px}
    .meter{height:8px; background:#0b1222; border:1px solid #1f2a44; border-radius:8px; overflow:hidden}
    .meter > span{display:block; height:100%; background:linear-gradient(90deg, #60a5fa, #34d399); width:50%}

    .sticky-footer{position:sticky; bottom:0; background:linear-gradient(180deg, #0b1222cc, #0b1222); border-top:1px solid #1f2a44; margin-top:8px; padding:12px; border-radius:14px}
    .foot-grid{display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center}

    .mini{font-size:12px}
    .floating-btn {position: fixed;right: 12px;bottom: 12px;z-index: 1000;padding: 10px 14px;background: linear-gradient(180deg,#12325a 0%,#0d2545 100%);
    border: 1px solid #1e3a5f;border-radius: 12px;color: #e5e7eb;font-weight: 600;cursor: pointer;box-shadow: 0 4px 12px rgba(0,0,0,.4);}
    .floating-btn:hover { filter: brightness(1.1); }
  </style>
</head>
<body>
  <div class="app">
    <!-- å·¦ï¼šç¸½è¦½ -->
    <aside class="panel stack">
      <div>
        <h1>ğŸ¡ å¸Œæœ›æ—…ç¨‹</h1>
        <div class="sub">å¡å…§åŠ çˆ¾çƒæ˜Ÿ Sadio ManÃ© çš„äººç”Ÿæ•…äº‹ï¼Œè¦‹è­‰ ~åœ¨çƒå ´å¤–ï¼Œç‚ºå®¶é„‰å‰µé€ å¸Œæœ›çš„åŠ›é‡ï¼Œä½ ä¹Ÿå¯ä»¥åšåˆ°ã€‚</div>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="label">å¯ç”¨è³‡é‡‘</div>
          <div class="money" id="money">$0</div>
        </div>
        <div class="card">
          <div class="label">æœˆä»½ï¼é€±æœŸ</div>
          <div class="val"><span id="month">1</span> / <span id="year">1</span>å¹´</div>
        </div>
        <div class="card">
          <div class="label">æœˆæ”¶å…¥ï¼ˆè·æ¶¯ï¼‰</div>
          <div class="val" id="income">$0</div>
        </div>
        <div class="card">
          <div class="label">ç¤¾ç¾¤ä¿¡ä»»</div>
          <div class="val" id="trust">50</div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="label">å†å‰é€²ä¸€é»</div>
            <div class="progress" aria-label="å½±éŸ¿åŠ›é€²åº¦">
              <div class="bar" id="impactBar"></div>
            </div>
          </div>
          <div class="pill" id="impactScore">0 åˆ†</div>
        </div>
      </div>

      <div class="card">
        <div class="label">æ‰€è¦‹çš„éœ€è¦</div>
        <div class="statrow">
          <div>
            æ•™è‚²
            <div class="meter"><span id="eduMeter" style="width:20%"></span></div>
          </div>
          <div>
            é†«ç™‚
            <div class="meter"><span id="healthMeter" style="width:20%"></span></div>
          </div>
          <div>
            ç”¨æ°´
            <div class="meter"><span id="waterMeter" style="width:20%"></span></div>
          </div>
          <div>
            å°±æ¥­
            <div class="meter"><span id="jobsMeter" style="width:20%"></span></div>
          </div>
          <div>
            é«”è‚²
            <div class="meter"><span id="sportsMeter" style="width:20%"></span></div>
          </div>
          <div>
            é‹è¡Œ
            <div class="meter"><span id="maintMeter" style="width:50%"></span></div>
          </div>
        </div>
      </div>

      <div class="row">
        <button class="btn btn-ghost" id="saveBtn">ğŸ’¾ ä¸»å‹•ä¼‘æ¯</button>
        <button class="btn btn-ghost" id="loadBtn">ğŸ“‚ è¼‰å…¥</button>
        <button class="btn btn-warn" id="resetBtn">ğŸ—‘ï¸ éŠæˆ²å¯é‡ä¾†</button>
      </div>
    </aside>

    <!-- ä¸­ï¼šæƒ…å¢ƒ / äº‹ä»¶å¡ -->
    <main class="panel">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h1>ğŸ“œ æœ¬æœˆäº‹ä»¶</h1>
          <div class="sub">æ ¹æ“šäº‹ä»¶åšæŠ‰æ“‡ï¼Œä½ çš„æ±ºå®šå½±éŸ¿è‘—æ‰€çœ‹è¦‹çš„éœ€è¦èˆ‡è²¡å‹™ã€‚</div>
        </div>
        <div class="pill" id="villageTag">ğŸ˜ï¸ å®¶é„‰ï¼šæœªå‘½å</div>
      </div>

      <div class="cards" id="eventList" aria-live="polite"></div>

      <div class="sticky-footer" id="footerBox">
       <div class="foot-grid">
        <div class="mini muted">
      æç¤ºï¼šæ¯å€‹æœˆæœƒè‡ªå‹•çµç®—é‹è¡Œæˆæœ¬èˆ‡å¸¶ä¾†çš„é•·æœŸæ”¶ç›Šã€‚ç¤¾ç¾¤ä¿¡ä»»æœƒå½±éŸ¿å‹Ÿè³‡èˆ‡å¿—å·¥åƒèˆ‡ã€‚
        </div>
      <button class="btn" id="skipBtn">â¡ï¸ ç¦±å‘Š</button>
     <button class="btn btn-acc" id="nextBtn">âœ… è¡Œå‹•</button>
  </div>
      </div>
    </main>

    <button id="toggleFooter" class="floating-btn" style="display:none;">ğŸ“Œ è¡Œå‹•</button>

    <!-- å³ï¼šå°ˆæ¡ˆè³‡æºåº« -->
    <aside class="panel right stack">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h1>ğŸ§­ å°ˆæ¡ˆé¸å–®</h1>
          <div class="sub">é¸æ“‡æƒ³è¡Œå‹•çš„åœ¨åœ°å°ˆæ¡ˆï¼ˆå¯é‡è¤‡å»ºç½®åœ¨å„åœ°ï¼‰ã€‚</div>
        </div>
        <button class="btn" id="renameBtn">âœï¸ è¨­å®šå®¶é„‰åç¨±</button>
      </div>

      <div class="cards" id="projectList"></div>
    </aside>
  </div>

  <script>
    // éŠæˆ²æ ¸å¿ƒç‹€æ…‹
    const Game = {
      month: 1,
      year: 1,
      money: 1, // åˆå§‹è³‡é‡‘
      baseIncome: 20000, // æ¯æœˆè·æ¶¯æ”¶å…¥ï¼ˆå¯æƒ³åƒç‚ºåˆç´„èˆ‡ä»£è¨€ï¼‰
      trust: 50, // 0-100
      metrics: { edu:20, health:20, water:20, jobs:20, sports:20, maint:50 }, // 0-100
      villageName: "æœªå‘½å",
      projects: [], // å»ºç½®ä¸­çš„å°ˆæ¡ˆ
      history: [], // äº‹ä»¶ç´€éŒ„
    };

    // å°ˆæ¡ˆè—åœ–ï¼ˆå¯è‡ªç”±æ“´å……ï¼‰
    const PROJECT_CATALOG = [
      {
        id:"school", name:"ğŸ“š å°å­¸ç¿»ä¿®", cost: 90000, monthlyUpkeep: 4000,
        effects:{ edu:+8, jobs:+1, maint:-1 }, longTerm:"æå‡å…¥å­¸ç‡èˆ‡å¸«è³‡æ„é¡˜"
      },
      {
        id:"clinic", name:"ğŸ¥ åŸºç¤è¨ºç™‚ç«™", cost: 120000, monthlyUpkeep: 6000,
        effects:{ health:+10, jobs:+1, maint:-2 }, longTerm:"é™ä½å¯é¿å…çš„ç–¾ç—…é¢¨éšª"
      },
      {
        id:"well", name:"ğŸš° æ·±æ°´äº•èˆ‡æ·¨æ°´", cost: 70000, monthlyUpkeep: 2000,
        effects:{ water:+12, health:+2, maint:-1 }, longTerm:"æ”¹å–„ç”¨æ°´ï¼Œæ¸›å°‘å–æ°´æ™‚é–“"
      },
      {
        id:"academy", name:"âš½ å°‘å¹´è¶³çƒè¨“ç·´ä¸­å¿ƒ", cost: 60000, monthlyUpkeep: 3000,
        effects:{ sports:+10, edu:+2, jobs:+1, maint:-1 }, longTerm:"ä»¥é‹å‹•å¸¶å‹•å‘ä¸Šèˆ‡å‡èš"
      },
      {
        id:"micro", name:"ğŸ’¼ å¾®å‹å‰µæ¥­åŸºé‡‘", cost: 50000, monthlyUpkeep: 0,
        effects:{ jobs:+8, trust:+3 }, longTerm:"æ”¯æŒå°åº—èˆ‡å®¶åº­ç”Ÿè¨ˆ"
      },
      {
        id:"solar", name:"ğŸ”† å¤ªé™½èƒ½è·¯ç‡ˆ", cost: 40000, monthlyUpkeep: 1000,
        effects:{ trust:+2, jobs:+1, maint:+1 }, longTerm:"æé«˜å¤œé–“å®‰å…¨èˆ‡æ´»å‹•"
      },
    ];

    // éš¨æ©Ÿäº‹ä»¶æ± 
    const EVENTS = [
      {
        id:"press",
        text:"åª’é«”é—œæ³¨ä½ çš„å®¶é„‰è¨ˆç•«ï¼Œè‹¥æ¥å—å°ˆè¨ªå¯æå‡ä¿¡ä»»ï¼Œä½†éœ€è´ŠåŠ©åœ¨åœ°æ´»å‹•ã€‚",
        choices:[
          {label:"æ¥å—ï¼šè´ŠåŠ©$10,000ï¼Œä¿¡ä»»+8", apply:s=>{s.money-=10000; s.trust=Math.min(100,s.trust+8)}},
          {label:"å©‰æ‹’ï¼šç„¡èŠ±è²»ï¼Œä¿¡ä»»-3", apply:s=>{s.trust=Math.max(0,s.trust-3)}}
        ]
      },
      {
        id:"flood",
        text:"æš´é›¨é€ æˆé“è·¯å—æï¼Œè‹¥ç«‹å³ä¿®è£œå¯é¿å…é‹è¡Œæƒ¡åŒ–ã€‚",
        choices:[
          {label:"ç·Šæ€¥ä¿®è£œï¼šèŠ±$20,000ï¼Œé‹è¡Œ+6", apply:s=>{s.money-=20000; s.metrics.maint=Math.min(100,s.metrics.maint+6)}},
          {label:"æš«ç·©ï¼šçœéŒ¢ä½†é‹è¡Œ-6", apply:s=>{s.metrics.maint=Math.max(0,s.metrics.maint-6)}}
        ]
      },
      {
        id:"sponsor",
        text:"å“ç‰Œé‚€è«‹å…¬ç›Šè¯åï¼Œè‹¥åƒèˆ‡å¯å¢åŠ æœˆæ”¶å…¥ä½†éœ€æ¯æœˆæŠ•å…¥å¿—å·¥æ™‚æ•¸ï¼ˆé™ä½é‹è¡Œå£“åŠ›ï¼‰ã€‚",
        choices:[
          {label:"åƒèˆ‡ï¼šæœˆæ”¶å…¥+$10,000ï¼Œé‹è¡Œ+2", apply:s=>{s.baseIncome+=10000; s.metrics.maint=Math.min(100,s.metrics.maint+2)}},
          {label:"ä¸åƒèˆ‡ï¼šä¿æŒç¾ç‹€", apply:s=>{}}
        ]
      },
      {
        id:"match",
        text:"æœ¬æœˆè³½äº‹è¡¨ç¾å‡ºè‰²ï¼Œç²å¾—æ¯”è³½çé‡‘$30,000ï¼Œæ˜¯å¦å…¨æ•¸æå…¥åŸºé‡‘ï¼Ÿ",
        choices:[
          {label:"å…¨æ•¸æŠ•å…¥å…¬ç›Šï¼ˆ+ä¿¡ä»»5ï¼‰", apply:s=>{s.money+=30000; s.trust=Math.min(100,s.trust+5)}},
          {label:"ä¿ç•™ä¸€åŠï¼ˆ+ç¾é‡‘15,000ï¼‰", apply:s=>{s.money+=15000}},
          {label:"è‡ªè¡Œé‹ç”¨ï¼ˆç„¡è®ŠåŒ–ï¼‰", apply:s=>{}}
        ]
      },
    ];

    // å·¥å…·
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const fmt = n => "$"+ n.toLocaleString();

    // ç‹€æ…‹æ¸²æŸ“
    function renderState(){
      $('#money').textContent = fmt(Game.money);
      $('#income').textContent = fmt(Game.baseIncome);
      $('#month').textContent = Game.month;
      $('#year').textContent = Game.year;
      $('#trust').textContent = Game.trust;
      $('#villageTag').textContent = `ğŸ˜ï¸ å®¶é„‰ï¼š${Game.villageName}`;

      // å½±éŸ¿åˆ†æ•¸ï¼ˆç°¡åŒ–ï¼šå„æŒ‡æ¨™å¹³å‡ + ä¿¡ä»»åŠ æ¬Šï¼‰
      const m = Game.metrics; const avg = (m.edu+m.health+m.water+m.jobs+m.sports+m.maint)/6;
      const impact = Math.round(avg*0.7 + Game.trust*0.3);
      const bar = Math.max(0, Math.min(100, impact));
      $('#impactBar').style.width = bar + '%';
      $('#impactScore').textContent = impact + ' åˆ†';

      // æŒ‡æ¨™æ¢
      $('#eduMeter').style.width = m.edu+'%';
      $('#healthMeter').style.width = m.health+'%';
      $('#waterMeter').style.width = m.water+'%';
      $('#jobsMeter').style.width = m.jobs+'%';
      $('#sportsMeter').style.width = m.sports+'%';
      $('#maintMeter').style.width = m.maint+'%';
    }

    // å°ˆæ¡ˆæ¸²æŸ“
    function renderProjects(){
      const box = $('#projectList');
      box.innerHTML = '';

      PROJECT_CATALOG.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'card project';
        el.innerHTML = `
          <div>
            <h3>${p.name}</h3>
            <div class="muted mini">ä¸€æ¬¡æˆæœ¬ï¼š${fmt(p.cost)}ï½œæ¯æœˆç¶­è­·æ”¯å‡ºï¼š${fmt(p.monthlyUpkeep)}<br>${p.longTerm}</div>
            <div class="row" style="gap:6px; flex-wrap:wrap; margin-top:8px">
              ${Object.entries(p.effects).map(([k,v])=>`<span class="tag">${labelOf(k)} ${v>0?'+':''}${v}</span>`).join('')}
            </div>
          </div>
          <div class="stack" style="align-items:end">
            <button class="btn btn-acc" ${Game.money<p.cost?'disabled':''}>æŠ•è³‡</button>
            <span class="pill mini">${Game.money<p.cost?'è³‡é‡‘ä¸è¶³':'å¯å»ºç½®'}</span>
          </div>
        `;
        el.querySelector('button').onclick=()=>buildProject(p);
        box.appendChild(el);
      });

      // å·²å»ºç½®æ¸…å–®
      if(Game.projects.length){
        const list = document.createElement('div');
        list.className='card';
        list.innerHTML = `<h3>å·²å»ºç½®èˆ‡é‹è¡Œ</h3>`;
        Game.projects.forEach((proj,i)=>{
          const row = document.createElement('div');
          row.className='row';
          row.style.justifyContent='space-between';
          row.style.marginTop='6px';
          row.innerHTML = `<div class="mini">${proj.name} <span class="muted">ï¼ˆç¬¬${proj.builtAt.year}å¹´${proj.builtAt.month}æœˆï¼‰</span></div>
                           <div class="pill mini">é‹è¡Œï¼š${fmt(proj.monthlyUpkeep)}</div>`;
          list.appendChild(row);
        })
        box.appendChild(list);
      }
    }

    function labelOf(k){
      return ({edu:'æ•™è‚²',health:'é†«ç™‚',water:'ç”¨æ°´',jobs:'å°±æ¥­',sports:'é«”è‚²',maint:'é‹è¡Œ',trust:'ä¿¡ä»»'})[k]||k;
    }

    function buildProject(p){
      if(Game.money < p.cost) return;
      Game.money -= p.cost;
      Game.projects.push({...p, builtAt:{year:Game.year, month:Game.month}});
      // å³æ™‚ä¿¡ä»»å¾®å¢ï¼ˆé€æ˜åº¦ï¼‰
      Game.trust = Math.min(100, Game.trust + (p.effects.trust?Math.max(1,p.effects.trust):1));
      renderState(); renderProjects();
      toast(`å·²å»ºç½®ï¼š${p.name}ï¼Œå®¶é„‰çœ‹è¦‹äº†ä½ çš„è¡Œå‹• ğŸ’š`);
    }

    // äº‹ä»¶ç”Ÿæˆèˆ‡æ¸²æŸ“
    function drawEvents(){
      const box = $('#eventList');
      box.innerHTML = '';
      const pool = pick(EVENTS, 2 + (Math.random()>0.7?1:0));
      pool.forEach(e=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h3>ï¼š${emojiFor(e.id)} ${e.text}</h3>`;
        e.choices.forEach(c=>{
          const btn = document.createElement('button');
          btn.className='btn'; btn.textContent=c.label;
          btn.onclick=()=>{ c.apply(Game); renderState(); disableCard(card); };
          card.appendChild(btn);
          card.appendChild(document.createTextNode(' '));
        });
        box.appendChild(card);
      });
    }
    function emojiFor(id){
      return ({press:'ğŸ“°', flood:'ğŸŒ§ï¸', sponsor:'ğŸ¤', match:'ğŸ¥‡'})[id] || 'ğŸ“Œ';
    }
    function disableCard(card){
      [...card.querySelectorAll('button')].forEach(b=>{b.disabled=true; b.classList.add('btn-ghost')});
      const note = document.createElement('div'); note.className='muted mini'; note.textContent='å·²é¸æ“‡'; card.appendChild(document.createElement('br')); card.appendChild(note);
    }

    // æœˆçµç®—
    function settleMonth(skipWarnings=false){
      // æ”¶å…¥
      Game.money += Game.baseIncome;
      // å°ˆæ¡ˆé‹è¡Œæˆæœ¬
      const upkeep = Game.projects.reduce((a,p)=>a+p.monthlyUpkeep,0);
      Game.money -= upkeep;
      // é•·æœŸæ•ˆæœç–ŠåŠ 
      Game.projects.forEach(p=>{
        for(const [k,v] of Object.entries(p.effects)){
          if(k==='trust'){ Game.trust = clamp(Game.trust + v*0.2,0,100); }
          else { Game.metrics[k] = clamp(Game.metrics[k] + v*0.5, 0, 100); }
        }
      });
      // é‹è¡Œä¸è¶³æ‡²ç½°
      if(Game.metrics.maint < 30){
        Game.trust = Math.max(0, Game.trust - 4);
        Game.metrics.edu = Math.max(0, Game.metrics.edu - 2);
        Game.metrics.health = Math.max(0, Game.metrics.health - 2);
      }
      // ç¾é‡‘ä¸è¶³è­¦ç¤º
      if(Game.money < 0 && !skipWarnings){
        alert('æ³¨æ„ï¼šç¾é‡‘æµç‚ºè² ï¼è«‹å¢åŠ æ”¶å…¥æˆ–æ¸›å°‘æ–°å»ºå°ˆæ¡ˆã€‚');
      }

      // æ™‚é–“éé€²
      Game.month++; if(Game.month>12){ Game.month=1; Game.year++; }
      renderState(); renderProjects(); drawEvents();
      toast('å·²çµç®—æœ¬æœˆï¼šæ”¶å…¥èˆ‡ç¶­é‹å·²é«”ç¾åœ¨æŒ‡æ¨™');
      saveAuto();
    }
    function skipToSettle(){
      toast('ä½ é¸æ“‡è·³éäº‹ä»¶ï¼Œç›´æ¥é€²å…¥çµç®—');
      settleMonth(true);
    }

    // å„²å­˜ / è¼‰å…¥
    function save(name='autosave'){
      localStorage.setItem('hometown_saver_'+name, JSON.stringify(Game));
      toast('å·²å„²å­˜é€²åº¦');
    }
    function load(name='autosave'){
      const raw = localStorage.getItem('hometown_saver_'+name);
      if(!raw){ toast('æ‰¾ä¸åˆ°å­˜æª”'); return; }
      const data = JSON.parse(raw);
      Object.assign(Game, data);
      renderState(); renderProjects(); drawEvents();
      toast('è¼‰å…¥æˆåŠŸ');
    }
    const saveAuto = ()=> save('autosave');

    // å…¶ä»–è¼”åŠ©
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function pick(arr, n){
      const pool = [...arr]; const out=[]; while(out.length<n && pool.length){
        const i = Math.floor(Math.random()*pool.length); out.push(pool.splice(i,1)[0]);
      } return out;
    }
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg; t.className='pill'; t.style.position='fixed'; t.style.right='18px'; t.style.bottom='18px'; t.style.zIndex=50; t.style.background='#0b1222ee'; t.style.border='1px solid #1f2a44';
      document.body.appendChild(t); setTimeout(()=>t.remove(), 2200);
    }

    // äº‹ä»¶ç¶å®š
    $('#nextBtn').onclick = ()=> settleMonth();
    $('#skipBtn').onclick = ()=> skipToSettle();
    $('#saveBtn').onclick = ()=> save('slot1');
    $('#loadBtn').onclick = ()=> load('slot1');
    $('#resetBtn').onclick = ()=>{ if(confirm('ç¢ºå®šè¦é–‹æ–°å±€å—ï¼Ÿç›®å‰é€²åº¦å°‡æ¸…é™¤ã€‚')){ localStorage.removeItem('hometown_saver_slot1'); localStorage.removeItem('hometown_saver_autosave'); location.reload(); } };
    $('#renameBtn').onclick = ()=>{
      const name = prompt('è«‹è¼¸å…¥ä½ çš„å®¶é„‰åç¨±ï¼ˆä¾‹å¦‚ï¼šç­å·´åˆ©ã€æ¸…æ°´æ‘â€¦ï¼‰', Game.villageName);
      if(name){ Game.villageName = name.trim().slice(0,20); renderState(); saveAuto(); }
    };

    // åˆå§‹åŒ–
    (function init(){
      renderState(); renderProjects(); drawEvents();
      // åˆå§‹æç¤º
      setTimeout(()=>toast('æç¤ºï¼šå…ˆå¾ã€Œæ·±æ°´äº•ã€æˆ–ã€Œå°å­¸ç¿»ä¿®ã€é–‹å§‹ï¼Œé€æ­¥å»ºç«‹ä¿¡ä»»'), 600);
    })();

    const footerBox = document.getElementById('footerBox');
    const toggleBtn = document.getElementById('toggleFooter');
  // 10ç§’å¾Œè‡ªå‹•æ”¶èµ·
  setTimeout(()=>{
    footerBox.style.display = "none";
    toggleBtn.style.display = "block";
  },10000);
  // é»æ“Šæµ®å‹•æŒ‰éˆ• â†’ å±•é–‹ / æ”¶èµ·
  toggleBtn.addEventListener('click', ()=>{
    if(footerBox.style.display==="none"){
      footerBox.style.display="block";
    }else{
      footerBox.style.display="none";
    }
  });

  const skipBtn = document.getElementById('skipBtn');
  const nextBtn = document.getElementById('nextBtn');
  // å‡è¨­æœ‰å€‹ç©å®¶ç‹€æ…‹
  let player = {
    income: 10000,   // æœ¬æœˆæ”¶å…¥
    cost: 4000,      // æœ¬æœˆæ”¯å‡º
    trust: 50,       // ç¤¾ç¾¤ä¿¡ä»»åº¦
    run: 100         // é‹è¡Œé»æ•¸
  };
  // è·³åˆ°çµç®—ï¼šæ”¶å…¥ç¸®å°ç‚ºååˆ†ä¹‹ä¸€ï¼Œé‹è¡Œä¸æ‰£
  skipBtn.addEventListener('click', () => {
    console.log("â¡ï¸ è·³åˆ°çµç®—ï¼šæ”¶å…¥è®Šæˆååˆ†ä¹‹ä¸€ï¼Œé‹è¡Œä¸æ‰£");
    runMonthlyCalculation(true);  // isSkip = true
    showSettlement("â¡ï¸ è·³åˆ°çµç®—");
  });
  // æ­£å¸¸çµç®—ï¼šæ”¶å…¥æ­£å¸¸ï¼Œé‹è¡Œæ‰£10
  nextBtn.addEventListener('click', () => {
    console.log("âœ… æ­£å¸¸çµç®—ï¼šæ”¶å…¥æ­£å¸¸ï¼Œé‹è¡Œæ‰£10");
    runMonthlyCalculation(false); // isSkip = false
    showSettlement("âœ… çµç®—æœ¬æœˆ");
  });
  // çµç®—é‹ç®—
  function runMonthlyCalculation(isSkip) {
    let finalIncome = isSkip ? player.income / 10 : player.income;
    let net = finalIncome - player.cost;
    console.log(`æ”¶å…¥ï¼š${finalIncome}`);
    console.log(`æ”¯å‡ºï¼š${player.cost}`);
    console.log(`æ·¨æ”¶ç›Šï¼š${net}`);
    // æ›´æ–°ç¤¾ç¾¤ä¿¡ä»»åº¦ï¼ˆåªæ˜¯ç¤ºç¯„ï¼‰
    if (net >= 0) {
      player.trust += 2;
    } else {
      player.trust -= 3;
    }
    // âœ… çµç®—æœ¬æœˆ â†’ æ‰£é‹è¡Œ10
    if (!isSkip) {
      player.run -= 10;
    }
    console.log(`ç¤¾ç¾¤ä¿¡ä»»åº¦ï¼š${player.trust}`);
    console.log(`é‹è¡Œï¼š${player.run}`);
  }
  // é¡¯ç¤ºçµç®—ç•«é¢
  function showSettlement(mode) {
    alert(`ğŸ“Š ${mode}\næ”¶å…¥ï¼š${player.income}\næ”¯å‡ºï¼š${player.cost}\nç¤¾ç¾¤ä¿¡ä»»ï¼š${player.trust}\né‹è¡Œï¼š${player.run}`);
  }

  </script>
</body>
</html>
