<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>棒球遊戲原型 — 整合修正版</title>
  <style>
    :root{ --bg:#071427; --panel:#0f1724; --accent:#f59e0b; --text:#e6eef8; }
    html,body{height:100%;margin:0;font-family:Inter, "Noto Sans TC", system-ui, sans-serif;background:linear-gradient(180deg,#071427 0%,#0b1220 100%);color:var(--text);} 
    .wrap{max-width:1200px;margin:16px auto;padding:14px;display:grid;grid-template-columns:720px 1fr;gap:12px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(2,6,23,0.6)}
    canvas{width:100%;height:520px;background:linear-gradient(180deg,#14422b,#072215);display:block;border-radius:8px}
    .sidebar{display:flex;flex-direction:column;gap:10px}
    .score{display:flex;gap:8px;align-items:center}
    .score .box{background:#071826;padding:8px 12px;border-radius:8px;font-weight:700}
    .controls{display:grid;gap:8px}
    .btn{background:var(--accent);color:#071427;padding:8px 10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .small{font-size:13px;color:#cfe7ff}
    .meter{height:10px;background:#0b2330;border-radius:999px;overflow:hidden}
    .meter > i{display:block;height:100%;background:linear-gradient(90deg,#ffd27a,#ff8a00);width:40%}
    .log{height:180px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:#cfe7ff}
    .row{display:flex;gap:8px;align-items:center}
    label{font-size:13px;color:#accbe6}
    select,input[type=range]{width:100%}
    footer{grid-column:1/-1;text-align:center;color:#8fb7dd;margin-top:8px;font-size:13px}
    .muted{color:#7ea8cc;font-size:13px}
    .tiny{font-size:12px;color:#9fc3ee}
    .panel-scroll{max-height:220px;overflow:auto;padding:6px;background:rgba(255,255,255,0.01);border-radius:8px}
    .touch-control{display:flex;gap:8px;align-items:center}
    #managementPanel{background:#f8fafc;color:#0b1220;padding:8px;border-radius:8px}
    .light-btn{background:#fff;color:#0b1220;border:1px solid #cbd5e1;padding:6px;border-radius:6px;cursor:pointer}
    .stat{font-size:12px;color:#cfe7ff}
.pitch-buttons {
  display: flex;
  gap: 6px;
  margin-top: 4px;
}

.pitch-btn {
  background: #fff;
  color: #000;
  border: 1px solid #000;
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
  font-weight: 600;
}

.pitch-btn.selected {
  background: #000;
  color: #fff;
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <canvas id="field" width="1280" height="720"></canvas>
    </div>

    <div class="panel sidebar">
      <div>
        <div class="score">
          <div class="box" id="inning">Inning: 1 (Top)</div>
          <div class="box" id="scoreboard">Home 0 - 0 Away</div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="small">Outs: <span id="outs">0</span></div>
          <div class="small">Runners: <span id="runners">—</span></div>
          <div class="small">Count: <span id="count">0-0</span></div>
        </div>
      </div>

      <div class="controls">
        <div>
  <label>投球類型（Pitch type）</label>
  <div id="pitchButtons" style="display:flex;gap:6px;margin-top:4px">
    <button class="btn pitch-btn" data-pitch="fast">快速球</button>
    <button class="btn pitch-btn" data-pitch="slider">滑球</button>
    <button class="btn pitch-btn" data-pitch="curve">曲球</button>
    <button class="btn pitch-btn" data-pitch="change">變速球</button>
        </div>

        <div>
          <label>瞄準（左右）</label>
          <input id="aim" type="range" min="-1" max="1" step="0.01" value="0">
        </div>

        <div>
          <label>球速 / 力道（Power）</label>
          <input id="power" type="range" min="0.4" max="1.2" step="0.01" value="0.95">
        </div>

        <div style="display:flex;gap:8px">
          <button id="pitchBtn" class="btn">投球 (Space)</button>
          <button id="swingBtn" class="btn" style="background:#22c55e">揮棒 (K / 拖曳)</button>
        </div>

        <div>
          <label>模式</label>
          <select id="mode">
            <option value="ai_vs_player">我（打者） vs AI（投手/守備）</option>
            <option value="player_vs_ai">我（投手/守備） vs AI（打者）</option>
            <option value="ai_vs_ai">AI 自動比賽（觀察）</option>
            <option value="local_two">本機雙人（傳機）</option>
          </select>
        </div>

        <div class="row">
          <button id="nextBat" class="btn" style="background:#6ee7b7">下一個打者</button>
          <button id="reset" class="btn" style="background:#ef4444">重置比賽</button>
        </div>

        <div class="row">
          <label>加速比賽</label>
          <input id="speed" type="range" min="0.2" max="2" step="0.1" value="1">
        </div>

        <div>
          <label>畫風</label>
          <select id="artStyle"><option value="flat">扁平 / 現代</option><option value="pixel">像素風</option></select>
        </div>

        <div>
          <label>觸控 / 拖曳揮棒</label>
          <div class="touch-control">
            <button id="toggleTouch" class="btn" style="background:#60a5fa">開啟觸控</button>
            <span class="tiny">（手機觸控：拖曳以決定揮棒角度與力度）</span>
          </div>
        </div>

      </div>

      <div>
        <div class="small muted">操作提示：按 Space 投球，按 K 揮棒或於畫面拖曳（開啟觸控後）。投手可選瞄準、球種與球速。模式可切換成本機雙人。</div>
        <div class="panel-scroll log" id="log">遊戲初始化中…</div>
      </div>

      <div class="panel" style="margin-top:6px">
        <div class="tiny">球員養成 / 球隊管理（簡易介面）</div>
        <div id="teamPanel" class="panel-scroll"></div>
        <div id="managementPanel" style="margin-top:8px">
          <div class="stat">資金: <span id="money">1000000</span></div>
          <div style="margin-top:6px">
            <button class="light-btn" id="tradeBtn">交易球員（-100,000）</button>
            <button class="light-btn" id="signBtn">簽下自由球員（-200,000）</button>
            <button class="light-btn" id="listBtn">顯示名單</button>
            <button class="light-btn" id="saveBtn">儲存球隊</button>
          </div>
        </div>
      </div>

    </div>

    <footer class="muted">整合修正版：保留玩家操作（打擊/投球）為主，AI 承擔對方打擊與守備。若要微調命中率或球種效果，可告訴我數字偏好。</footer>
  </div>

<script>
/* ------------------------
   Integrated Baseball Prototype (fixed counts & integration)
   - Player operates batting/pitching depending on mode
   - AI handles opponent batting & fielding
   - Proper ball/strike count, walks, strikeouts, outs, inning switching
   ------------------------ */

// canvas setup
const canvas = document.getElementById('field');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;

// Game state
const GAME = {
  inning: 1,
  top: true,
  outs: 0,
  score: {home:0, away:0},
  bases: [null,null,null], // objects: {team:'home'|'away', idx:playerIdx}
  count: {balls:0, strikes:0},
  lineupIdx: {home:0, away:0},
  battingTeam: 'away', // who is batting now
  fieldingTeam: 'home',
  rngSeed: Math.random()*10000,
  speed: 1,
  artStyle: 'flat',
  touchEnabled: false,
  announcer: true
};

// Team & players
function makeTeam(name){
  const players = [];
  for(let i=0;i<9;i++){
    players.push({
      id: i,
      name: `${name}#${i+1}`,
      contact: Math.round((Math.random()*0.35+0.45)*100)/100, // ~0.45-0.8
      power: Math.round((Math.random()*0.5+0.3)*100)/100,
      speed: Math.round((Math.random()*0.5+0.4)*100)/100,
      field: Math.round((Math.random()*0.5+0.4)*100)/100,
      xp: 0, level: 1
    });
  }
  return {name, players};
}
const AWAY = makeTeam('Away');
const HOME = makeTeam('Home');

let USER_TEAM = { money: 1000000, roster: HOME.players };

// UI refs
const pitchBtn = document.getElementById('pitchBtn');
const swingBtn = document.getElementById('swingBtn');
const aimEl = document.getElementById('aim');
const powerEl = document.getElementById('power');
const pitchTypeEl = document.getElementById('pitchType');
const modeEl = document.getElementById('mode');
const nextBatBtn = document.getElementById('nextBat');
const resetBtn = document.getElementById('reset');
const speedEl = document.getElementById('speed');
const logEl = document.getElementById('log');
const artStyleEl = document.getElementById('artStyle');
const toggleTouchBtn = document.getElementById('toggleTouch');
const teamPanel = document.getElementById('teamPanel');
const moneyEl = document.getElementById('money');

function uiUpdate(){
  document.getElementById('inning').innerText = `Inning: ${GAME.inning} (${GAME.top? 'Top' : 'Bottom'})`;
  document.getElementById('outs').innerText = GAME.outs;
  document.getElementById('count').innerText = `${GAME.count.balls}-${GAME.count.strikes}`;
  document.getElementById('scoreboard').innerText = `Home ${GAME.score.home} - ${GAME.score.away} Away`;
  const runners = GAME.bases.map((b,i)=> b!==null ? `${b.team[0].toUpperCase()}${b.idx+1}` : '-').join(' ');
  document.getElementById('runners').innerText = runners;
  teamPanel.innerHTML = renderTeamPanel();
  moneyEl.innerText = USER_TEAM.money;
}

// logging
function log(msg){
  const p = document.createElement('div'); p.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
  logEl.prepend(p);
  // optionally play announcer sounds later
}

// RNG
function rand(){ GAME.rngSeed = (GAME.rngSeed*9301+49297)%233280; return GAME.rngSeed/233280; }

// Fielding helpers
function getFielderPositions(cx,cy,size){
  const spread = size;
  return {
    P: {x:cx, y:cy-40}, C: {x:cx, y:cy+spread*0.8},
    '1B': {x:cx+spread*0.5, y:cy-spread*0.2}, '2B': {x:cx, y:cy+spread*0.0}, '3B': {x:cx-spread*0.5, y:cy-spread*0.2},
    LF: {x:cx+spread*0.9, y:cy-spread*0.6}, CF: {x:cx, y:cy-spread*0.9}, RF: {x:cx-spread*0.9, y:cy-spread*0.6}
  };
}
const FIELD_POS_TO_IDX = {P:7,C:8,'1B':0,'2B':1,'SS':2,'3B':3,'LF':4,'CF':5,'RF':6};

function fieldBall(fielderPosName, hitType){
  const teamObj = (GAME.fieldingTeam === 'home') ? HOME : AWAY;
  const fIdx = FIELD_POS_TO_IDX[fielderPosName] ?? 4;
  const f = teamObj.players[fIdx];
  const fieldSkill = f.field;
  const baseChance = 0.55 * fieldSkill + 0.25; // slightly lower to allow hits sometimes
  const success = rand() < baseChance;
  if(!success){ log(`${fielderPosName} 發生失誤`); }
  return success;
}

// Pitch & contact resolution (improved balance)
function resolvePitch(pitch){
  // Determine whether pitch is in zone -> more accurate if aim near 0 and power sufficient
  const loc = pitch.aim + (Math.random()-0.5)*0.4;
  const inZone = Math.abs(loc) < 0.35 && pitch.power > 0.5;
  const battingTeam = GAME.battingTeam === 'away' ? AWAY : HOME;
  const batter = battingTeam.players[ GAME.lineupIdx[GAME.battingTeam] ];
  // determine whether batter will swing (AI)
  const mode = modeEl.value;
  let autoSwing = (mode === 'ai_vs_player' && GAME.battingTeam==='away') || (mode==='player_vs_ai' && GAME.battingTeam==='home') || (mode==='ai_vs_ai');
  let swung=false; let swingTiming=0.5;
  if(autoSwing){
    // if ball out of zone: lower swing chance; if in zone: higher
    const swingProb = Math.max(0.12, Math.min(0.98, batter.contact * (inZone ? 0.95 : 0.45)));
    swung = rand() < swingProb;
    swingTiming = 0.35 + rand()*0.6;
  }
  return {inZone, swung, swingTiming, batter, loc};
}

function makeContactExtended(pitch, swingTiming, batter){
  // base quality from batter contact + timing + pitch difficulty
  let quality = (batter.contact - 0.5) + (Math.random()-0.5)*0.55 + (0.5 - Math.abs(pitch.aim))*0.5 + (pitch.power-0.85);
  quality += (0.5 - Math.abs(0.5 - swingTiming)) * 1.0;
  quality = Math.max(-1, Math.min(1, quality));
  if(quality < -0.35) return {result:'miss', quality};
  const powerFactor = batter.power;
  const base = quality*0.6 + powerFactor*0.8 + rand()*0.5;
  if(base > 1.4) return {result:'homer', quality};
  if(base > 0.85) return {result:'triple', quality};
  if(base > 0.35) return {result:'double', quality};
  if(base > -0.05) return {result:'single', quality};
  return {result:'weak', quality};
}

// Runner animation system
const RUNNERS = [];
function animateRunner(start, end, duration, meta){
  const t0 = performance.now();
  RUNNERS.push({start,end,duration,t0,meta});
}
function updateRunners(){
  const now = performance.now();
  for(let i=RUNNERS.length-1;i>=0;i--){
    const r = RUNNERS[i];
    const p = Math.min(1, (now - r.t0)/r.duration);
    r.current = {x: r.start.x + (r.end.x - r.start.x)*p, y: r.start.y + (r.end.y - r.start.y)*p};
    if(p>=1){
      if(r.meta && r.meta.onComplete) r.meta.onComplete();
      RUNNERS.splice(i,1);
    }
  }
}

// Apply play results and properly update counts/out/inning
function applyPlayExtended(outcome, batterIdx){
  const batting = GAME.battingTeam === 'away' ? AWAY : HOME;
  // outcome: miss, weak, single/double/triple/homer
  if(outcome === 'miss'){
    GAME.count.strikes += 1;
    log('揮空或未擊中（計為好球）');
    if(GAME.count.strikes >= 3){
      GAME.outs += 1;
      giveXP(batting.players[batterIdx], 5);
      log('三振出局');
      resetCount();
      advanceBatter();
    }
  } else if(outcome === 'weak'){
    GAME.outs += 1;
    log('弱擊出局（滾地球）');
    giveXP(batting.players[batterIdx], 3);
    resetCount();
    advanceBatter();
  } else if(['single','double','triple','homer'].includes(outcome)){
    // hits
    const baseIdxAdvance = {single:1,double:2,triple:3,homer:4}[outcome];
    let runs = 0;
    for(let i=2;i>=0;i--){
      const runner = GAME.bases[i];
      if(runner){
        const newBaseIndex = i + baseIdxAdvance;
        if(newBaseIndex >= 3){
          runs++;
          GAME.bases[i] = null;
        } else {
          const start = baseCoord(i), end = baseCoord(newBaseIndex);
          animateRunner(start,end,700,{onComplete:()=>{}});
          GAME.bases[newBaseIndex] = runner;
          GAME.bases[i] = null;
        }
      }
    }
    if(outcome === 'homer'){
      runs++; // batter scores
    } else {
      GAME.bases[baseIdxAdvance-1] = {team: GAME.battingTeam, idx: batterIdx};
    }
    if(GAME.battingTeam === 'away') GAME.score.away += runs; else GAME.score.home += runs;
    log(`${outcome}！跑回 ${runs} 分`);
    giveXP(batting.players[batterIdx], 10 + runs*2);
    resetCount();
    advanceBatter();
  }
  // after play, check outs -> if >=3 end half inning
  if(GAME.outs >= 3) endHalfInning();
  uiUpdate();
}

function baseCoord(baseIndex){
  const cx = W/2, cy = H/2; // 內野中心
  const size = 300;          // 方形內野寬度的一半

  // baseIndex: 0=Home, 1=1B, 2=2B, 3=3B
  const posMap = [
    { x: cx,          y: cy + size/2 }, // Home Plate 下方
    { x: cx + size/2, y: cy },          // 1B 右側
    { x: cx,          y: cy - size/2 }, // 2B 上方
    { x: cx - size/2, y: cy }           // 3B 左側
  ];

  return posMap[baseIndex] || {x:cx, y:cy};
}

function giveXP(player, amount){
  player.xp += amount;
  while(player.xp >= xpForNext(player.level)){
    player.xp -= xpForNext(player.level);
    player.level++; player.contact = Math.min(0.99, player.contact + 0.02); player.power = Math.min(0.99, player.power + 0.02);
    log(`${player.name} 升級到 Lv.${player.level}`);
  }
}
function xpForNext(lv){ return 20 + lv*10; }

function endHalfInning(){
  GAME.outs = 0;
  resetCount();
  GAME.bases = [null,null,null];
  if(GAME.top){
    GAME.top = false;
    GAME.fieldingTeam = GAME.battingTeam;
    GAME.battingTeam = (GAME.battingTeam==='away' ? 'home' : 'away');
  } else {
    GAME.top = true; GAME.inning += 1;
    GAME.fieldingTeam = GAME.battingTeam;
    GAME.battingTeam = (GAME.battingTeam==='away' ? 'home' : 'away');
  }
  log('換半局 — ' + (GAME.top ? '上半' : '下半'));
  uiUpdate();
}

// advance lineup
function advanceBatter(){ GAME.lineupIdx[GAME.battingTeam] = (GAME.lineupIdx[GAME.battingTeam] + 1) % 9; }

// count helpers
function resetCount(){ GAME.count.balls = 0; GAME.count.strikes = 0; }
function addBallAndCheckWalk(){
  GAME.count.balls += 1;
  if(GAME.count.balls >= 4){
    // walk
    log('四壞保送');
    // advance batter to first (force)
    const batterIdx = GAME.lineupIdx[GAME.battingTeam];
    // shift runners
    for(let i=2;i>=0;i--){
      if(GAME.bases[i] && i===2){ // runner on 3rd scores if forced
        GAME.score[GAME.bases[i].team === 'away' ? 'away' : 'home'] += 1;
      }
    }
    // simple forced advance: push array
    GAME.bases.unshift({team: GAME.battingTeam, idx: batterIdx});
    GAME.bases.pop();
    uiUpdate();
    resetCount();
    advanceBatter();
  }
}
function addStrikeAndCheckK(){
  GAME.count.strikes += 1;
  if(GAME.count.strikes >= 3){
    GAME.outs += 1;
    log('三振出局');
    const batterIdx = GAME.lineupIdx[GAME.battingTeam];
    giveXP((GAME.battingTeam==='away'?AWAY:HOME).players[batterIdx], 5);
    resetCount();
    advanceBatter();
    if(GAME.outs >= 3) endHalfInning();
  }
}

// Input & touch handling
let awaitingSwing = false;
let currentPitch = null;
let dragStart = null, dragActive = false;

pitchBtn.addEventListener('click', ()=>{ doPitch(); });
swingBtn.addEventListener('click', ()=>{ doSwingByPlayer(); });
resetBtn.addEventListener('click', resetGame);
nextBatBtn.addEventListener('click', ()=>{ advanceBatter(); uiUpdate(); log('手動切換下一打者'); });
speedEl.addEventListener('input', ()=>{ GAME.speed = Number(speedEl.value); });
artStyleEl.addEventListener('change', ()=>{ GAME.artStyle = artStyleEl.value; });
toggleTouchBtn.addEventListener('click', ()=>{ GAME.touchEnabled = !GAME.touchEnabled; toggleTouchBtn.innerText = GAME.touchEnabled ? '關閉觸控' : '開啟觸控'; log('觸控模式 ' + (GAME.touchEnabled?'已開啟':'已關閉')); });

// keyboard
window.addEventListener('keydown', (e)=>{
  if(e.code==='Space'){ e.preventDefault(); doPitch(); }
  if(e.key.toLowerCase()==='k'){ e.preventDefault(); doSwingByPlayer(); }
});

// touch / drag for swinging
canvas.addEventListener('pointerdown',(e)=>{
  if(!GAME.touchEnabled) return;
  dragStart = {x:e.offsetX, y:e.offsetY}; dragActive = true;
});
canvas.addEventListener('pointermove',(e)=>{ /* optional guide */ });
canvas.addEventListener('pointerup',(e)=>{
  if(!dragActive) return; dragActive=false;
  const dx = e.offsetX - dragStart.x; const dy = e.offsetY - dragStart.y;
  const timing = Math.min(1, Math.max(0, 0.5 + (dx/800)));
  if(awaitingSwing){
    awaitingSwing = false;
    // Player swung
    const batting = GAME.battingTeam === 'away' ? AWAY : HOME;
    const batter = batting.players[ GAME.lineupIdx[GAME.battingTeam] ];
    const outcome = makeContactExtended(currentPitch, timing, batter);
    handleSwingOutcome(outcome, GAME.lineupIdx[GAME.battingTeam], true);
  }
});

// doPitch integrates good/bad ball, and AI automatic responses
function doPitch(){
  if(awaitingSwing){ log('等待揮棒...'); return; }
  // currentpitch includes type/aim/power and a computed inZone
  const pitch = { type: currentPitchType, aim: Number(aimEl.value), power: Number(powerEl.value) };
  currentPitch = pitch;
  const res = resolvePitch(pitch);
  // If batting side is AI and AI is set to swing, process immediately
  const mode = modeEl.value;
  const playerIsPitcher = (mode === 'player_vs_ai' && GAME.battingTeam === 'away') || (mode === 'ai_vs_player' && GAME.battingTeam === 'home') || (mode === 'local_two' && GAME.battingTeam !== getLocalPlayerBattingSide());
  // Determine if the batter is AI and should swing automatically
  if( (mode === 'player_vs_ai' && GAME.battingTeam === 'away') || (mode === 'ai_vs_player' && GAME.battingTeam === 'home') || mode === 'ai_vs_ai' ){
    if(res.swung){
      const outcome = makeContactExtended(pitch, res.swingTiming, res.batter);
      handleSwingOutcome(outcome, GAME.lineupIdx[GAME.battingTeam], false);
    } else {
      // no swing -> called strike if in zone, else ball
      if(res.inZone){
        addStrikeAndCheckK();
        log('好球（未揮棒）');
      } else {
        addBallAndCheckWalk();
        log('壞球（未揮棒）');
      }
      uiUpdate();
    }
    return;
  }
  // Otherwise, player is batting -> wait for swing input
  // Or player is pitching and AI batting: allow AI to auto-swing after small delay
  if((mode === 'player_vs_ai' && GAME.battingTeam === 'home') || (mode === 'ai_vs_player' && GAME.battingTeam === 'away') ){
    // if AI batting, decide swing quickly
    if(res.swung){
      const outcome = makeContactExtended(pitch, res.swingTiming, res.batter);
      handleSwingOutcome(outcome, GAME.lineupIdx[GAME.battingTeam], false);
    } else {
      if(res.inZone){ addStrikeAndCheckK(); log('好球（未揮棒）'); }
      else { addBallAndCheckWalk(); log('壞球（未揮棒）'); }
      uiUpdate();
    }
    return;
  }
  // Otherwise player is batting: set awaitingSwing and allow player to swing or time out
  awaitingSwing = true;
  log('投球完成 — 等待揮棒（按 K 或拖曳）');
  setTimeout(()=>{
    if(awaitingSwing){
      awaitingSwing = false;
      // auto-judge as called ball/strike
      const res2 = resolvePitch(pitch);
      if(res2.inZone){ addStrikeAndCheckK(); log('好球（未揮棒）'); }
      else{ addBallAndCheckWalk(); log('壞球（未揮棒）'); }
      uiUpdate();
    }
  }, 1200 / GAME.speed);
}

// centralized swing outcome handling
function handleSwingOutcome(outcome, batterIdx, isPlayerSwing){
  if(outcome.result === 'miss'){
    addStrikeAndCheckK();
    log((isPlayerSwing? '玩家':'AI') + ' 揮空/未擊中');
  } else if(outcome.result === 'weak'){
    GAME.outs += 1;
    log('弱擊出局');
    giveXP((GAME.battingTeam==='away'?AWAY:HOME).players[batterIdx], 3);
    resetCount();
    advanceBatter();
    if(GAME.outs >= 3) endHalfInning();
  } else {
    // hit: single/double/triple/homer
    applyPlayExtended(outcome.result, batterIdx);
  }
  uiUpdate();
}

// when player presses swing (K)
function doSwingByPlayer(){
  if(!awaitingSwing){ log('目前不是揮棒時機'); return; }
  awaitingSwing = false;
  const pitch = currentPitch;
  const timing = 0.45 + (Number(powerEl.value)-0.4)/1.6 * 0.2 + (Math.random()-0.5)*0.25;
  const batting = GAME.battingTeam === 'away' ? AWAY : HOME;
  const batter = batting.players[ GAME.lineupIdx[GAME.battingTeam] ];
  const outcome = makeContactExtended(pitch, timing, batter);
  handleSwingOutcome(outcome, GAME.lineupIdx[GAME.battingTeam], true);
}

// reset game
function resetGame(){
  GAME.inning = 1; GAME.top = true; GAME.outs = 0; GAME.score = {home:0, away:0};
  GAME.bases = [null,null,null]; resetCount();
  GAME.lineupIdx = {home:0, away:0}; GAME.battingTeam = 'away'; GAME.fieldingTeam = 'home';
  GAME.rngSeed = Math.random()*10000;
  log('遊戲重置');
  uiUpdate();
}

// Drawing
function drawField(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#0b2a1c'; ctx.fillRect(0,0,W,H);
  const cx = W/2, cy = H*0.55, size = 260;
  ctx.fillStyle = GAME.artStyle==='pixel' ? '#a78b5b' : '#bda27a';
  ctx.beginPath(); ctx.moveTo(cx, cy - size); ctx.lineTo(cx + size, cy); ctx.lineTo(cx, cy + size); ctx.lineTo(cx - size, cy); ctx.closePath(); ctx.fill();
  const bcoords = [ {x:cx+size*0.45, y:cy- size*0.25}, {x:cx, y:cy+size*0.12}, {x:cx - size*0.45, y:cy - size*0.25} ];
  ctx.fillStyle = '#fff'; bcoords.forEach((b,i)=>{ ctx.fillRect(b.x-12,b.y-12,24,24); });
  ctx.fillStyle = '#d6b687'; ctx.beginPath(); ctx.arc(cx, cy - 40, 22, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.moveTo(cx, cy+size*0.85); ctx.lineTo(cx+16, cy+size*0.85-12); ctx.lineTo(cx, cy+size*0.85-26); ctx.lineTo(cx-16, cy+size*0.85-12); ctx.closePath(); ctx.fill();

  // draw bases runners
GAME.bases.forEach((runner,i)=>{
  if(runner){
    const pos = baseCoord(i);
    ctx.fillStyle = '#ffefc2';
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, GAME.artStyle==='pixel'?8:14,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle='#073642';
    ctx.font = (GAME.artStyle==='pixel'?'10px monospace':'14px sans-serif');
    ctx.fillText(runner.team[0].toUpperCase()+ (runner.idx+1), pos.x-8, pos.y+5);
  }
});
  // animated runners
  RUNNERS.forEach(r=>{ const p = r.current || r.start; ctx.fillStyle='#ffd9b3'; ctx.beginPath(); ctx.arc(p.x,p.y, GAME.artStyle==='pixel'?7:12,0,Math.PI*2); ctx.fill(); });
  const fpos = getFielderPositions(cx,cy,size);
  Object.keys(fpos).forEach(k=>{ const p = fpos[k]; ctx.fillStyle='#cfe7ff'; ctx.font='12px sans-serif'; ctx.fillText(k, p.x-6, p.y-6); });
  ctx.fillStyle = 'rgba(2,10,20,0.6)'; ctx.fillRect(12,12,360,88);
  ctx.fillStyle = '#bde4ff'; ctx.font = '18px sans-serif'; ctx.fillText(`Inning ${GAME.inning} ${GAME.top? 'Top':'Bottom'}`, 24,36);
  ctx.fillText(`Score H:${GAME.score.home} A:${GAME.score.away}`, 24,64);
  ctx.fillStyle='#cfe7ff'; ctx.font='14px sans-serif'; ctx.fillText(`Outs:${GAME.outs}  B/S:${GAME.count.balls}/${GAME.count.strikes}`, 200,64);
}
function loop(){ updateRunners(); drawField(); requestAnimationFrame(loop); }

// Team panel
function renderTeamPanel(){
  function renderTeam(team){
    return `<div style="margin-bottom:8px"><strong>${team.name}</strong><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px">` + team.players.map(p=>`<div style="background:rgba(255,255,255,0.02);padding:6px;border-radius:6px"><div style="font-weight:700">${p.name}</div><div class='tiny'>Lv${p.level} XP:${p.xp}/${xpForNext(p.level)}</div><div class='tiny'>C:${p.contact} P:${p.power} S:${p.speed} F:${p.field}</div></div>`).join('') + '</div></div>';
  }
  return renderTeam(HOME) + renderTeam(AWAY);
}

// Management buttons
document.getElementById('tradeBtn').addEventListener('click', ()=>{
  if(USER_TEAM.money >= 100000){ USER_TEAM.money -= 100000; USER_TEAM.roster.push({id: USER_TEAM.roster.length, name: '交易球員', contact:0.5, power:0.5, speed:0.5, field:0.5, xp:0, level:1}); log('完成交易：花費 100,000'); uiUpdate(); } else { log('資金不足無法交易'); }
});
document.getElementById('signBtn').addEventListener('click', ()=>{
  if(USER_TEAM.money >= 200000){ USER_TEAM.money -= 200000; USER_TEAM.roster.push({id: USER_TEAM.roster.length, name: '自由球員', contact:0.52, power:0.48, speed:0.5, field:0.5, xp:0, level:1}); log('簽下自由球員：花費 200,000'); uiUpdate(); } else { log('資金不足無法簽約'); }
});
document.getElementById('listBtn').addEventListener('click', ()=>{ log('球隊名單：' + USER_TEAM.roster.map(p=>p.name).join(', ')); });
document.getElementById('saveBtn').addEventListener('click', ()=>{
  try{ localStorage.setItem('myBaseballTeam', JSON.stringify(USER_TEAM)); log('球隊資料已儲存到 localStorage'); } catch(e){ log('儲存失敗：' + e.message); }
});

// helper: determine local player batting side in local_two (simple toggle)
function getLocalPlayerBattingSide(){ // returns 'home' or 'away' representing local player's batting side in local_two
  // default: local player controls home team batting when mode local_two and it's bottom half
  return GAME.top ? 'away' : 'home';
}

// initialize
resetGame(); uiUpdate(); loop(); log('整合修正版啟動 — Player controls batting/pitching per mode.');

// Expose some functions for quick testing (optional)
window.doPitch = doPitch;
window.doSwingByPlayer = doSwingByPlayer;
window.resetGame = resetGame;
window.advanceBatter = advanceBatter;

let batter = { contact: 70, power: 60 }; // 打者：contact命中、power長打
let pitcher = { control: 65, strike: 75 }; // 投手：control控球、strike三振能力

function calculateHitProb(batter, pitcher) {
    // 基礎機率
    let prob = {
        strikeout: 0.20,
        flyball: 0.30,
        groundball: 0.30,
        line: 0.2
    };

    // 能力差
    const diff = (batter.contact + batter.power) - (pitcher.control + pitcher.strike);

    // 調整倍率：差距越大 → 打者越容易成功
    const adjust = diff / 200; // 差距/200 讓影響合理

    prob.strikeout = Math.max(0.05, prob.strikeout - adjust); // 最少5%
    prob.flyball = Math.min(0.4, prob.flyball - adjust/2);
    prob.groundball = Math.min(0.5, prob.groundball - adjust/2);
    prob.line = 1 - (prob.strikeout + prob.flyball + prob.groundball);

    return prob;
}

function determineHitType(batter, pitcher) {
    const prob = calculateHitProb(batter, pitcher);
    const rand = Math.random();

    if (rand < prob.strikeout) return "strikeout";
    else if (rand < prob.strikeout + prob.flyball) return "flyball";
    else if (rand < prob.strikeout + prob.flyball + prob.groundball) return "groundball";
    else return "line"; // 安打
}

function handleFlyball(baseRunners, hitDistance) {
    // 如果擊出外野深遠球 (hitDistance 大於某值) -> 全壘打
    if (hitDistance >= FIELD_HOMERUN_DISTANCE) {
        return { type: "homerun", score: baseRunners.length + 1, bases: [] };
    } else {
        // 一般高飛球 -> 可能出局
        const outChance = 0.7; // 70% 高飛球會被接殺
        if (Math.random() < outChance) {
            return { type: "out", outCount: 1, doublePlay: false };
        } else {
            // 安打或安全飛球 (sacrifice fly)
            // 僅二三壘跑者得分
            let score = 0;
            const newBases = baseRunners.map(runner => {
                if (runner.base >= 2) { score++; return null; } // 得分
                return runner; // 留在壘上
            });
            return { type: "sacfly", score, bases: newBases };
        }
    }
}

function handleGroundball(baseRunners) {
    // 基本假設: 1出局 -> 可能形成雙殺
    let outCount = 1;
    let doublePlay = false;

    // 如果一壘有跑者 & 滾地球打向內野，判定雙殺
    if (baseRunners.some(r => r.base === 1) && Math.random() < 0.25) {
        outCount = 2;
        doublePlay = true;
        baseRunners = baseRunners.filter(r => r.base !== 1); // 一壘跑者出局
    }

    // 移動其他壘上跑者
    baseRunners = baseRunners.map(runner => {
        if (runner.base === 1) return null; // 已出局
        runner.base += 1; // 前進一壘
        return runner;
    }).filter(r => r !== null);

    return { type: "groundball", outCount, doublePlay, bases: baseRunners };
}

function handleStrikeout() {
    // 單純出局，無壘上跑者前進
    return {
        type: "strikeout",
        outCount: 1,
        doublePlay: false,
        bases: null
    };
}

function processHit(baseRunners, hitDistance) {
    const hitType = determineHitType();

    switch(hitType) {
        case "strikeout":
            return handleStrikeout();
        case "flyball":
            return handleFlyball(baseRunners, hitDistance);
        case "groundball":
            return handleGroundball(baseRunners);
        default:
            return handleLineHit(baseRunners, hitType); // 單打/二壘打/三壘打/全壘打
    }
}

let currentPitchType = 'fast';
document.querySelectorAll('.pitch-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.pitch-btn').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    currentPitchType = btn.dataset.type;
    log(`選擇投球：${btn.innerText}`);
  });
});

// 修改投球函式
function doPitch(){
  if(awaitingSwing){ log('等待揮棒...'); return; }
  const pitch = { type: currentPitchType, aim: Number(aimEl.value), power: Number(powerEl.value) };
  currentPitch = pitch;
  const res = resolvePitch(pitch);
  // 以下保持原本 doPitch 內邏輯...
}

</script>
</body>
</html>
